name: KAIROS CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Code Quality (Ruff)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install Ruff
        run: pip install ruff==0.2.1
      - name: Ruff Check
        run: ruff check .
      - name: Ruff Format Check
        run: ruff format --check .

  test:
    name: Unit & Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Dependency Vulnerability Scan
        run: |
          pip install pip-audit
          pip-audit
      - name: Security Linting (Bandit)
        run: |
          pip install bandit
          bandit -r src/ app/ -f json -o bandit-report.json
          bandit -r src/ app/
      - name: Supply Chain Security (Snyk)
        uses: snyk/actions/python-3.12@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --skip-unresolved
      - name: Run Tests
        run: |
          export PYTHONPATH=$PYTHONPATH:.
          pytest --cov=src --cov=app --cov-report=term-missing --cov-report=xml --cov-fail-under=75 tests/
      - name: Code Quality Regression Gate
        run: |
          export PYTHONPATH=$PYTHONPATH:.
          python src/kairos/evaluate.py

  docs:
    name: Documentation Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install validator
        run: pip install openapi-spec-validator
      - name: Validate OpenAPI Spec
        run: openapi-spec-validator openapi.yaml
      - name: Verify Required Docs
        run: |
          test -f README.md
          test -f docs/ARCHITECTURE.md
          test -f docs/ONBOARDING.md
          test -f docs/RESEARCH.md
      - name: Markdown Link Check
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: "yes"
          config-file: "mlc_config.json"
